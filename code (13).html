<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Armario Digital++</title>
    <!-- Incluir Chart.js desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* --- Estilos CSS (Igual que la versión anterior) --- */
        :root { --primary-color: #4a4a4a; --secondary-color: #f4f4f4; --accent-color: #5dadec; --danger-color: #d9534f; --warning-color: #f0ad4e; --success-color: #5cb85c; --text-color: #333; --border-color: #ddd; }
        * { box-sizing: border-box; }
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: var(--secondary-color); color: var(--text-color); display: flex; min-height: 100vh; }
        #sidebar { width: 220px; background-color: var(--primary-color); color: white; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 1000; height: 100vh; position: fixed; left: 0; top: 0; transform: translateX(0); }
        #sidebar h2 { margin-top: 0; text-align: center; font-size: 1.4em; }
        #sidebar nav ul { list-style: none; padding: 0; margin: 20px 0 0 0; width: 100%; }
        #sidebar nav li { margin-bottom: 10px; }
        #sidebar nav button { background: none; border: none; color: white; padding: 10px 15px; width: 100%; text-align: left; cursor: pointer; font-size: 1em; border-radius: 4px; transition: background-color 0.3s ease; }
        #sidebar nav button:hover, #sidebar nav button.active { background-color: rgba(255, 255, 255, 0.2); }
        #main-content { flex-grow: 1; padding: 20px; padding-top: 60px; margin-left: 220px; transition: margin-left 0.3s ease; overflow-y: auto; }
        #menu-toggle { display: none; position: fixed; top: 10px; left: 10px; z-index: 1010; background-color: var(--primary-color); color: white; border: none; padding: 8px 12px; font-size: 1.5em; cursor: pointer; border-radius: 4px; line-height: 1; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; }
        .section { display: none; background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section.active { display: block; }
        h3, h4 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; margin-bottom: 15px; }
        h4 { font-size: 1.1em; border-bottom-width: 1px; margin-top: 20px;}
        form label{display:block;margin-bottom:5px;font-weight:700}form input[type=text],form input[type=number],form input[type=file],form select,form textarea{width:100%;padding:10px;margin-bottom:15px;border:1px solid var(--border-color);border-radius:4px;font-size:1em}form input[type=color]{padding:5px;height:40px;margin-bottom:15px;vertical-align:middle;width:auto}form .file-input-area{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:15px}form #item-image{width:auto;flex-grow:1}form #take-photo-btn{padding:8px 12px;font-size:.9em}form button[type=submit],.btn{background-color:var(--accent-color);color:#fff;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:1em;transition:background-color .3s ease;margin-right:5px;margin-bottom:5px}form button[type=submit]:hover,.btn:hover{background-color:#4a9cd6}.btn-danger{background-color:var(--danger-color)}.btn-danger:hover{background-color:#c9302c}.btn-warning{background-color:var(--warning-color)}.btn-warning:hover{background-color:#ec971f}.btn-secondary{background-color:#ccc;color:#333}.btn-secondary:hover{background-color:#bbb}#camera-view{display:none;margin-top:15px;margin-bottom:15px;padding:15px;border:1px solid var(--border-color);background-color:#f9f9f9;border-radius:8px}#camera-stream{width:100%;max-width:400px;display:block;margin:0 auto 10px auto;border:1px solid var(--border-color);background-color:#000}#camera-controls{text-align:center}#capture-btn,#cancel-camera-btn{margin:0 5px}#photo-canvas{display:none}#items-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px}.item-card{border:1px solid var(--border-color);border-radius:8px;padding:10px;background-color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.05);display:flex;flex-direction:column;position:relative}.item-card img{max-width:100%;height:130px;object-fit:contain;margin-bottom:8px;background-color:#eee;border-radius:4px}.item-card strong{display:block;margin-bottom:4px;font-size:1em;word-wrap:break-word}.item-card p{font-size:.85em;margin:2px 0;color:#555;flex-grow:1;word-wrap:break-word}.item-card .usage-info{font-size:.8em;color:#888}.item-card .status{font-weight:700;padding:2px 5px;border-radius:4px;font-size:.75em;display:inline-block;margin-top:4px;text-transform:capitalize}.status-nuevo{background-color:var(--success-color);color:#fff}.status-bueno{background-color:#a1d4a1;color:#333}.status-desgastado{background-color:var(--warning-color);color:#fff}.status-donar{background-color:var(--accent-color);color:#fff}.status-tirar{background-color:var(--danger-color);color:#fff}.item-card .actions{margin-top:8px;display:flex;justify-content:space-around;flex-wrap:wrap;gap:5px}.item-card .actions button{padding:4px 6px;font-size:.75em;flex-grow:1;min-width:60px}#filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;padding:10px;background-color:#f9f9f9;border-radius:4px;border:1px solid var(--border-color)}#filters label{margin-right:5px;font-weight:400;align-self:center}#filters input,#filters select{padding:8px;font-size:.9em;border-radius:4px;border:1px solid var(--border-color);flex-grow:1;min-width:120px}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4)}.modal-content{background-color:#fefefe;margin:10% auto;padding:20px;border:1px solid #888;width:90%;max-width:600px;border-radius:8px;position:relative}.modal-close{color:#aaa;position:absolute;top:10px;right:20px;font-size:28px;font-weight:700;cursor:pointer;line-height:1}.modal-close:hover,.modal-close:focus{color:#000;text-decoration:none}.list-item{border-bottom:1px solid var(--border-color);padding:10px 0;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px}.list-item:last-child{border-bottom:none}.list-item .content{flex-grow:1;word-wrap:break-word}.list-item .actions{flex-shrink:0;display:flex;flex-direction:column;gap:5px;align-items:flex-end}.list-item .usage-info{font-size:.8em;color:#888;margin-top:4px}#outfit-items-selection{max-height:250px;overflow-y:auto;border:1px solid var(--border-color);padding:10px;margin-bottom:15px}#outfit-items-selection label{display:block;margin-bottom:5px;cursor:pointer}#outfit-items-selection input[type=checkbox]{margin-right:8px;vertical-align:middle}.alert{padding:15px;margin-bottom:20px;border:1px solid transparent;border-radius:4px;font-size:.9em}.alert ul{margin:5px 0 0 20px;padding:0}.alert li{margin-bottom:3px}.alert-info{color:#31708f;background-color:#d9edf7;border-color:#bce8f1}.alert-warning{color:#8a6d3b;background-color:#fcf8e3;border-color:#faebcc}.alert-secondary{color:#383d41;background-color:#e2e3e5;border-color:#d6d8db}.alert-danger{color:#a94442;background-color:#f2dede;border-color:#ebccd1}#stats-content .stats-section{margin-bottom:30px}#stats-content .chart-container{position:relative;margin:auto;height:250px;width:100%;max-width:400px;margin-bottom:20px}#stats-content .weekly-stats p{margin:5px 0}
        @media (max-width: 768px){#menu-toggle{display:block}#sidebar{transform:translateX(-100%);box-shadow:2px 0 5px rgba(0,0,0,.2)}#sidebar.open{transform:translateX(0)}#main-content{margin-left:0;padding:15px;padding-top:60px;width:100%}#overlay.active{display:block}#items-list{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}.item-card{padding:8px}.item-card img{height:110px}.item-card strong{font-size:.95em}.item-card p{font-size:.8em}.item-card .status{font-size:.7em}.item-card .actions button{font-size:.7em;padding:3px 5px}#filters{flex-direction:column;align-items:stretch}#filters label{margin-bottom:3px;align-self:flex-start}#filters input,#filters select,#filters button{width:100%;margin-right:0}form .file-input-area{flex-direction:column;align-items:stretch}form #item-image{margin-bottom:10px;width:100%}form #take-photo-btn{width:100%}#camera-view{padding:10px}#camera-stream{max-width:100%}.modal-content{width:95%;margin:5% auto;padding:15px}.modal-close{top:5px;right:10px;font-size:24px}form input[type=color]{display:inline-block;margin-left:5px;vertical-align:middle}#add-wishlist-item-form input{width:100%;margin-bottom:10px}.list-item{align-items:center}.list-item .actions{width:100%;flex-direction:row;justify-content:space-around;margin-top:10px}.list-item .actions button{flex-grow:1}#stats-content .chart-container{height:200px}}
    </style>
</head>
<body>
    <button id="menu-toggle">☰</button>
    <div id="overlay"></div>
    <aside id="sidebar"> <h2>Mi Armario</h2> <nav> <ul> <li><button class="nav-btn active" data-section="view-all">Ver Prendas</button></li> <li><button class="nav-btn" data-section="add-item">Añadir</button></li> <li><button class="nav-btn" data-section="view-outfits">Outfits</button></li> <li><button class="nav-btn" data-section="create-outfit">Crear Outfit</button></li> <li><button class="nav-btn" data-section="wishlist">Wishlist</button></li> <li><button class="nav-btn" data-section="stats">Stats</button></li> <li><button class="nav-btn" data-section="alerts">Alertas</button></li> <li><button class="nav-btn" data-section="settings">Ajustes</button></li> </ul> </nav> </aside>

    <main id="main-content">
        <section id="add-item" class="section"> <h3 id="form-title">Añadir/Editar Prenda</h3> <form id="item-form"> <input type="hidden" id="item-id"> <label for="item-name">Nombre:</label><input type="text" id="item-name" required> <label for="item-type">Tipo:</label><select id="item-type" required><option value="" disabled selected>Selecciona...</option><option value="camisa">Camisa</option><option value="camiseta">Camiseta</option><option value="blusa">Blusa</option><option value="jersey">Jersey</option><option value="sudadera">Sudadera</option><option value="chaqueta">Chaqueta</option><option value="abrigo">Abrigo</option><option value="pantalon">Pantalón</option><option value="falda">Falda</option><option value="vestido">Vestido</option><option value="zapatos">Zapatos</option><option value="botas">Botas</option><option value="sandalias">Sandalias</option><option value="deportivas">Deportivas</option><option value="bolso">Bolso</option><option value="accesorio">Accesorio</option></select> <label for="item-color">Color:</label><div><input type="text" id="item-color" placeholder="Ej: Azul marino" style="width: calc(100% - 55px); display: inline-block; vertical-align: middle; margin-right: 5px;"><input type="color" id="item-color-picker" title="Selector de color"></div> <label for="item-season">Temporada:</label><select id="item-season"><option value="todo-ano">Todo el año</option><option value="primavera">Primavera</option><option value="verano">Verano</option><option value="otono">Otoño</option><option value="invierno">Invierno</option></select> <label for="item-brand">Marca:</label><input type="text" id="item-brand" placeholder="Ej: Marca X"> <label for="item-status">Estado:</label><select id="item-status" required><option value="en buen estado">En buen estado</option><option value="nuevo">Nuevo</option><option value="desgastado">Desgastado</option><option value="para donar">Para donar</option><option value="para tirar">Para tirar</option></select> <label for="item-image">Foto:</label><div class="file-input-area"><input type="file" id="item-image" accept="image/*"><button type="button" id="take-photo-btn" class="btn btn-secondary">📸 Tomar Foto</button></div> <img id="image-preview" src="#" alt="Vista previa" style="max-width: 100px; max-height: 100px; display: none; margin-bottom: 10px;" /> <div id="camera-view"><video id="camera-stream" autoplay playsinline></video><canvas id="photo-canvas"></canvas><div id="camera-controls"><button type="button" id="capture-btn" class="btn">Capturar</button><button type="button" id="cancel-camera-btn" class="btn btn-secondary">Cancelar</button></div></div> <label for="item-notes">Notas:</label><textarea id="item-notes" rows="3"></textarea> <button type="submit" id="save-item-btn">Guardar</button><button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Cancelar</button> </form> </section>
        <section id="view-all" class="section active"> <h3>Mis Prendas</h3> <div id="filters"> <label for="filter-search">Buscar:</label><input type="text" id="filter-search" placeholder="Nombre, marca..."><label for="filter-type">Tipo:</label><select id="filter-type"><option value="">Todos</option></select><label for="filter-color">Color:</label><input type="text" id="filter-color" placeholder="Ej: azul"><label for="filter-season">Temporada:</label><select id="filter-season"><option value="">Todas</option><option value="primavera">Primavera</option><option value="verano">Verano</option><option value="otono">Otoño</option><option value="invierno">Invierno</option><option value="todo-ano">Todo el año</option></select><label for="filter-status">Estado:</label><select id="filter-status"><option value="">Todos</option><option value="nuevo">Nuevo</option><option value="en buen estado">En buen estado</option><option value="desgastado">Desgastado</option><option value="para donar">Para donar</option><option value="para tirar">Para tirar</option></select><button class="btn btn-secondary" id="reset-filters">Limpiar</button> </div> <div id="items-list"><p>Cargando...</p></div> </section>
        <section id="view-outfits" class="section"> <h3>Mis Outfits</h3> <div id="outfits-list"><p>Cargando...</p></div> </section>
        <section id="create-outfit" class="section"> <h3>Crear Outfit</h3> <form id="outfit-form"> <label for="outfit-name">Nombre:</label><input type="text" id="outfit-name" required> <label>Prendas:</label><div id="outfit-items-selection"><p>Cargando...</p></div> <label for="outfit-notes">Notas:</label><textarea id="outfit-notes" rows="2"></textarea> <button type="submit">Guardar</button> </form> </section>
        <section id="wishlist" class="section"> <h3>Wishlist</h3> <form id="add-wishlist-item-form" style="margin-bottom: 20px;"> <input type="text" id="wishlist-item-name" placeholder="Nombre prenda" required style="margin-right: 10px;"> <input type="text" id="wishlist-item-link" placeholder="Enlace (opcional)" style="margin-right: 10px;"> <button type="submit" class="btn">Añadir</button> </form> <div id="wishlist-items"><p>Cargando...</p></div> </section>
        <section id="stats" class="section">
            <h3>Estadísticas</h3>
            <div id="stats-content">
                <p>Calculando...</p>
                <div class="stats-section weekly-stats"> <h4>Resumen y Semanal</h4> <p>Prendas: <strong id="stats-total-items">...</strong></p> <p>Outfits: <strong id="stats-total-outfits">...</strong></p> <p>Usadas semana*: <strong id="stats-weekly-items">...</strong></p> <p>Outfits semana*: <strong id="stats-weekly-outfits">...</strong></p> <p style="font-size: 0.8em; color: #666;">*Últimos 7 días</p> </div>
                <div class="stats-section charts"> <h4>Distribución</h4> <div class="chart-container"> <canvas id="typeChart"></canvas> </div> <div class="chart-container"> <canvas id="statusChart"></canvas> </div> <h4>Top 5 Prendas</h4> <div class="chart-container" style="height: 300px;"> <canvas id="topItemsChart"></canvas> </div> </div>
            </div>
        </section>
        <section id="alerts" class="section"> <h3>Alertas</h3> <div id="alerts-content"><p>Buscando...</p></div> </section>
        <section id="settings" class="section"> <h3>Ajustes y Datos</h3> <p><strong>Importante:</strong> Guarda localmente. Exporta regularmente.</p> <button id="export-data-btn" class="btn">Exportar</button><br><br> <p>Importar:</p><input type="file" id="import-data-input" accept=".json"><button id="import-data-btn" class="btn">Importar</button><p style="color: var(--danger-color); font-size: 0.9em;">Reemplaza datos.</p><br><hr> <button id="delete-all-data-btn" class="btn btn-danger">Borrar Todo</button><p style="color: var(--danger-color); font-size: 0.9em;">Irreversible.</p> </section>
        <div id="edit-modal" class="modal"> <div class="modal-content"> <span class="modal-close" onclick="closeModal()">&times;</span> <h3>Editar Prenda</h3> <div id="edit-form-container"></div> </div> </div>
    </main>

    <script>
        const App = {
            // --- Selectores DOM ---
            menuToggle:document.getElementById('menu-toggle'),overlay:document.getElementById('overlay'),sidebar:document.getElementById('sidebar'),mainContent:document.getElementById('main-content'),navButtons:document.querySelectorAll('.nav-btn'),sections:document.querySelectorAll('.section'),itemsList:document.getElementById('items-list'),itemForm:document.getElementById('item-form'),formTitle:document.getElementById('form-title'),itemIdInput:document.getElementById('item-id'),itemNameInput:document.getElementById('item-name'),itemTypeInput:document.getElementById('item-type'),itemColorInput:document.getElementById('item-color'),itemColorPicker:document.getElementById('item-color-picker'),itemSeasonInput:document.getElementById('item-season'),itemBrandInput:document.getElementById('item-brand'),itemStatusInput:document.getElementById('item-status'),itemImageInput:document.getElementById('item-image'),imagePreview:document.getElementById('image-preview'),itemNotesInput:document.getElementById('item-notes'),saveItemBtn:document.getElementById('save-item-btn'),cancelEditBtn:document.getElementById('cancel-edit-btn'),takePhotoButton:document.getElementById('take-photo-btn'),cameraView:document.getElementById('camera-view'),cameraStreamElement:document.getElementById('camera-stream'),captureButton:document.getElementById('capture-btn'),cancelCameraButton:document.getElementById('cancel-camera-btn'),photoCanvas:document.getElementById('photo-canvas'),filterSearch:document.getElementById('filter-search'),filterType:document.getElementById('filter-type'),filterColor:document.getElementById('filter-color'),filterSeason:document.getElementById('filter-season'),filterStatus:document.getElementById('filter-status'),resetFiltersBtn:document.getElementById('reset-filters'),outfitsList:document.getElementById('outfits-list'),outfitForm:document.getElementById('outfit-form'),outfitNameInput:document.getElementById('outfit-name'),outfitItemsSelection:document.getElementById('outfit-items-selection'),outfitNotesInput:document.getElementById('outfit-notes'),wishlistItemsContainer:document.getElementById('wishlist-items'),addWishlistItemForm:document.getElementById('add-wishlist-item-form'),wishlistItemNameInput:document.getElementById('wishlist-item-name'),wishlistItemLinkInput:document.getElementById('wishlist-item-link'),statsContent:document.getElementById('stats-content'),alertsContent:document.getElementById('alerts-content'),exportBtn:document.getElementById('export-data-btn'),importInput:document.getElementById('import-data-input'),importBtn:document.getElementById('import-data-btn'),deleteAllBtn:document.getElementById('delete-all-data-btn'),editModal:document.getElementById('edit-modal'),editFormContainer:document.getElementById('edit-form-container'),modalCloseBtn:document.querySelector('.modal-close'),addItemSection:document.getElementById('add-item'),
            statsTotalItems: document.getElementById('stats-total-items'), statsTotalOutfits: document.getElementById('stats-total-outfits'), statsWeeklyItems: document.getElementById('stats-weekly-items'), statsWeeklyOutfits: document.getElementById('stats-weekly-outfits'),

            // --- Estado ---
            data: { items: [], outfits: [], wishlist: [], config: { nextItemId: 1, nextOutfitId: 1, nextWishlistItemId: 1 } },
            editingItemId: null, currentStream: null, typeChartInstance: null, statusChartInstance: null, topItemsChartInstance: null,
            alertOveruseThreshold: 100, alertStatusStagnationDays: 90,

            // --- Init ---
            init() { console.log("Init..."); try{this.loadData(); this.addEventListeners(); this.renderItems(); this.populateFilterOptions(); this.navigateToSection('view-all'); console.log("Ready."); }catch(e){console.error("Fatal init error:",e);alert("Error starting. Check console.");} },

            // --- Data ---
            loadData() { const d=localStorage.getItem('wardrobeApp'); if(d){try{this.data=JSON.parse(d);this.data.items=this.data.items||[];this.data.outfits=this.data.outfits||[];this.data.wishlist=this.data.wishlist||[];this.data.config=this.data.config||{nI:1,nO:1,nW:1};this.data.config.nextItemId=this.data.config.nextItemId||this.data.config.nI||(this.data.items.length?Math.max(0,...this.data.items.map(i=>i?.id||0)):0)+1;this.data.config.nextOutfitId=this.data.config.nextOutfitId||this.data.config.nO||(this.data.outfits.length?Math.max(0,...this.data.outfits.map(o=>o?.id||0)):0)+1;this.data.config.nextWishlistItemId=this.data.config.nextWishlistItemId||this.data.config.nW||(this.data.wishlist.length?Math.max(0,...this.data.wishlist.map(w=>w?.id||0)):0)+1;this.data.items.forEach(i=>{if(i&&typeof i==='object'){i.statusHistory=i.statusHistory||[];}}); this.data.outfits.forEach(o=>{if(o&&typeof o==='object'){o.timesWorn=o.timesWorn||0;o.lastWorn=o.lastWorn||null;}});}catch(e){console.error("Parse error:",e);this.initializeEmptyData();}}else{this.initializeEmptyData();}if(!Array.isArray(this.data.items))this.data.items=[];if(!Array.isArray(this.data.outfits))this.data.outfits=[];if(!Array.isArray(this.data.wishlist))this.data.wishlist=[]; },
            initializeEmptyData() { this.data={items:[],outfits:[],wishlist:[],config:{nextItemId:1,nextOutfitId:1,nextWishlistItemId:1}};console.log("Data initialized."); },
            saveData() { try{localStorage.setItem('wardrobeApp',JSON.stringify(this.data));}catch(e){console.error("Save error:",e);alert("Error saving data!");} },
            getNextId(type) { let id;switch(type){case 'item':id=this.data.config.nextItemId++;break;case 'outfit':id=this.data.config.nextOutfitId++;break;case 'wishlist':id=this.data.config.nextWishlistItemId++;break;default:id=Date.now()+Math.random();}this.saveData();return id; },

            // --- Nav & Menu ---
            navigateToSection(sectionId) { try{this.sections.forEach(s=>s.classList.remove('active'));this.navButtons.forEach(b=>b.classList.remove('active'));const tS=document.getElementById(sectionId);const tB=document.querySelector(`.nav-btn[data-section="${sectionId}"]`);if(tS){tS.classList.add('active');if(sectionId==='view-all')this.renderItems();if(sectionId==='view-outfits')this.renderOutfits();if(sectionId==='create-outfit')this.populateOutfitItemSelection();if(sectionId==='wishlist')this.renderWishlist();if(sectionId==='stats')this.renderStats();if(sectionId==='alerts')this.renderAlerts();if(sectionId==='add-item'){this.resetForm();this.formTitle.textContent='Añadir';this.saveItemBtn.textContent='Guardar';this.cancelEditBtn.style.display='none';if(!this.addItemSection.contains(this.itemForm)){this.addItemSection.appendChild(this.itemForm);}}}if(tB){tB.classList.add('active');}this.closeMobileMenu();}catch(e){console.error(`Nav error ${sectionId}:`,e)} },
            toggleMobileMenu() { this.sidebar.classList.toggle('open'); this.overlay.classList.toggle('active',this.sidebar.classList.contains('open')); },
            closeMobileMenu() { if(this.sidebar.classList.contains('open')){this.sidebar.classList.remove('open');this.overlay.classList.remove('active');} },

            // --- Camera ---
            async initCamera() { console.log("Cam init...");this.stopCameraStream();if('mediaDevices' in navigator&&'getUserMedia' in navigator.mediaDevices){try{this.currentStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});}catch(err){console.warn("Fallback cam:",err);try{this.currentStream=await navigator.mediaDevices.getUserMedia({video:true});}catch(error){console.error("Cam error:",error);alert(`No access: ${error.name}`);this.currentStream=null;return;}}if(this.currentStream){this.cameraStreamElement.srcObject=this.currentStream;this.cameraView.style.display='block';console.log("Cam ready.");}}else{alert("Cam not supported.");} },
            capturePhoto() { if(!this.currentStream)return;const ctx=this.photoCanvas.getContext('2d');const v=this.cameraStreamElement;const w=v.videoWidth;const h=v.videoHeight;if(!w||!h){this.photoCanvas.width=640;this.photoCanvas.height=480;try{ctx.drawImage(v,0,0,640,480);}catch(e){}}else{this.photoCanvas.width=w;this.photoCanvas.height=h;ctx.drawImage(v,0,0,w,h);}const url=this.photoCanvas.toDataURL('image/jpeg',0.9);this.imagePreview.src=url;this.imagePreview.style.display='block';this.stopCameraStream(); },
            stopCameraStream() { if(this.currentStream){this.currentStream.getTracks().forEach(t=>t.stop());this.currentStream=null;this.cameraStreamElement.srcObject=null;}this.cameraView.style.display='none'; },

            // --- Items ---
            renderItems(fI=null) { try{const iTR=fI!==null?fI:this.data.items;this.itemsList.innerHTML='';if(!iTR||iTR.length===0){this.itemsList.innerHTML='<p>No hay prendas.</p>';return;}iTR.forEach(i=>{if(!i||typeof i!=='object')return;const c=document.createElement('div');c.classList.add('item-card');c.dataset.id=i.id;const sM={'nuevo':'status-nuevo','en buen estado':'status-bueno','desgastado':'status-desgastado','para donar':'status-donar','para tirar':'status-tirar'};const sC=sM[i.status?.toLowerCase()]||'';c.innerHTML=`<img src="${i.imageUrl||'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" alt="${i.name||''}"><strong title="${i.name||''}">${(i.name||'S/N').substring(0,25)}${(i.name||'').length>25?'...':''}</strong><p>T: ${i.type||'N/A'}</p><p>C: ${i.color||'N/A'}</p><p class="usage-info">U:${i.timesWorn||0}. ${i.lastWorn?`Ú:${new Date(i.lastWorn).toLocaleDateString()}`:''}</p><p>E:<span class="status ${sC}">${i.status||'N/A'}</span></p><div class="actions"><button class="btn btn-secondary btn-sm" onclick="App.markAsWorn(${i.id})">Usado</button><button class="btn btn-warning btn-sm" onclick="App.openEditModal(${i.id})">Edt</button><button class="btn btn-danger btn-sm" onclick="App.deleteItem(${i.id})">Del</button></div>`;this.itemsList.appendChild(c);});}catch(e){console.error("Render items error:",e);this.itemsList.innerHTML='<p style="color:red;">Error mostrando prendas.</p>';} },
            handleFormSubmit(event) { try{event.preventDefault();const itemId=this.editingItemId?parseInt(this.editingItemId):null;const item=itemId?this.findItemById(itemId):null;const itemData={id:itemId||this.getNextId('item'),name:this.itemNameInput.value.trim(),type:this.itemTypeInput.value,color:this.itemColorInput.value.trim(),season:this.itemSeasonInput.value,brand:this.itemBrandInput.value.trim(),status:this.itemStatusInput.value,imageUrl:this.imagePreview.src.startsWith('data:image')?this.imagePreview.src:(item?.imageUrl||null),notes:this.itemNotesInput.value.trim(),dateAdded:item?.dateAdded||Date.now(),lastWorn:item?.lastWorn||null,timesWorn:item?.timesWorn||0,statusHistory:item?.statusHistory||[]};if(itemId){if(item&&item.status!==itemData.status){itemData.statusHistory=Array.isArray(itemData.statusHistory)?itemData.statusHistory:[];itemData.statusHistory.push({status:itemData.status,date:Date.now()});}}else{itemData.statusHistory=[{status:itemData.status,date:Date.now()}];}if(itemId){const idx=this.data.items.findIndex(i=>i?.id===itemId);if(idx>-1){this.data.items[idx]=itemData;}this.closeModal();}else{this.data.items.push(itemData);}this.saveData();this.renderItems();this.populateFilterOptions();this.resetForm();if(!itemId){this.navigateToSection('view-all');}}catch(e){console.error("Save item error:",e);alert("Error saving item.");} },
            findItemById(id) { return this.data.items.find(item=>item?.id===id); },
            openEditModal(id) { try{const item=this.findItemById(id);if(!item)return;this.editingItemId=id;this.editFormContainer.innerHTML='';this.editFormContainer.appendChild(this.itemForm);this.formTitle.textContent='Editar';this.saveItemBtn.textContent='Guardar';this.itemIdInput.value=item.id;this.itemNameInput.value=item.name;this.itemTypeInput.value=item.type;this.itemColorInput.value=item.color||'';this.itemColorPicker.value=this.rgbToHex(item.color)||'#000000';this.itemSeasonInput.value=item.season||'todo-ano';this.itemBrandInput.value=item.brand||'';this.itemStatusInput.value=item.status;this.itemNotesInput.value=item.notes||'';if(item.imageUrl){this.imagePreview.src=item.imageUrl;this.imagePreview.style.display='block';}else{this.imagePreview.src='#';this.imagePreview.style.display='none';}this.itemImageInput.value='';this.cancelEditBtn.style.display='inline-block';this.editModal.style.display='block';}catch(e){console.error("Open modal error:",e);} },
            closeModal() { this.stopCameraStream();this.editModal.style.display='none';this.editingItemId=null;this.addItemSection.appendChild(this.itemForm);this.resetForm(); },
            handleCancelEdit() { this.stopCameraStream();this.closeModal(); },
            rgbToHex(c) { if(!c)return null;if(c.startsWith('#'))return c;const b={'negro':'#000','blanco':'#fff','rojo':'#f00','verde':'#080','azul':'#00f','amarillo':'#ff0','gris':'#888','marron':'#a52','naranja':'#fa0','rosa':'#fcc','morado':'#808','beige':'#f5d'};const l=c.toLowerCase();if(b[l]){return b[l];}if(l.startsWith('rgb')){try{let p=l.match(/\d+/g);if(p&&p.length>=3){let h=p.slice(0,3).map(n=>{let v=parseInt(n).toString(16);return v.length===1?'0'+v:v;}).join('');return '#'+h;}}catch(e){return null;}}return null; },
            resetForm() { this.stopCameraStream();this.itemForm.reset();this.imagePreview.src='#';this.imagePreview.style.display='none';this.itemIdInput.value='';this.editingItemId=null;this.formTitle.textContent='Añadir';this.saveItemBtn.textContent='Guardar';this.cancelEditBtn.style.display='none';if(!this.addItemSection.contains(this.itemForm)){this.addItemSection.appendChild(this.itemForm);} },
            deleteItem(id) { try{const item=this.findItemById(id);const iName=item?.name||'prenda';if(confirm(`Borrar ${iName}?`)){this.data.items=this.data.items.filter(i=>i?.id!==id);this.saveData();this.renderItems();this.populateFilterOptions();console.log(`ID ${id} deleted.`);}}catch(e){console.error("Delete item error:",e);} },
             _updateItemWornStatus(item) { if(item&&typeof item==='object'){item.timesWorn=(item.timesWorn||0)+1;item.lastWorn=Date.now();return true;}console.warn("Invalid item update:",item);return false; },
            markAsWorn(id, preventSaveAndRender=false) { try{const item=this.findItemById(id);if(this._updateItemWornStatus(item)){if(!preventSaveAndRender){this.saveData();const card=this.itemsList.querySelector(`.item-card[data-id="${id}"]`);if(card){const ui=card.querySelector('.usage-info');if(ui){ui.textContent=`U:${item.timesWorn}. Últ.: ${new Date(item.lastWorn).toLocaleDateString()}`;}}if(document.getElementById('stats')?.classList.contains('active')){this.renderStats();}}}}catch(e){console.error("Mark worn error:",e);} },

            handleImagePreview(event) { // <<<<< PUNTO DEL ERROR ANTERIOR
                 this.stopCameraStream();
                 const file = event.target.files[0];
                 if (file) {
                     if (file.size > 2*1024*1024) { alert("Max 2MB"); this.itemImageInput.value = ""; this.imagePreview.src='#'; this.imagePreview.style.display='none'; return; }
                     const reader = new FileReader(); // 'reader' definition
                     reader.onload = (e) => { this.imagePreview.src = e.target.result; this.imagePreview.style.display = 'block'; }
                     reader.readAsDataURL(file);
                 } else {
                     const cId=this.editingItemId; const cItem = cId ? this.findItemById(cId) : null;
                     if (cItem?.imageUrl) { this.imagePreview.src = cItem.imageUrl; this.imagePreview.style.display = 'block'; }
                     else if (!this.imagePreview.src.startsWith('data:image')) { this.imagePreview.src = '#'; this.imagePreview.style.display = 'none'; }
                 }
            }, // <<<----- CORRECCIÓN: Coma añadida aquí

            // --- Filtros ---
            populateFilterOptions() { try{const types=[...new Set(this.data.items.map(i=>i?.type))].filter(Boolean).sort();const curVal=this.filterType.value;this.filterType.innerHTML='<option value="">Todos</option>';types.forEach(t=>{const opt=document.createElement('option');opt.value=t;opt.textContent=t.charAt(0).toUpperCase()+t.slice(1);this.filterType.appendChild(opt);});if(types.includes(curVal)){this.filterType.value=curVal;}}catch(e){console.error("Filter options error:",e);} },
            applyFilters() { try{const sT=this.filterSearch.value.toLowerCase();const sTy=this.filterType.value;const fC=this.filterColor.value.toLowerCase();const sS=this.filterSeason.value;const sSt=this.filterStatus.value;const filt=this.data.items.filter(i=>{if(!i)return false;const nM=!sT||(i.name&&i.name.toLowerCase().includes(sT));const bM=!sT||(i.brand&&i.brand.toLowerCase().includes(sT));const oM=!sT||(i.notes&&i.notes.toLowerCase().includes(sT));const tM=!sTy||i.type===sTy;const cM=!fC||(i.color&&i.color.toLowerCase().includes(fC));const eM=!sS||i.season===sS;const stM=!sSt||i.status===sSt;return(nM||bM||oM)&&tM&&cM&&eM&&stM;});this.renderItems(filt);}catch(e){console.error("Filter apply error:",e);} },
            resetFilters() { this.filterSearch.value='';this.filterType.value='';this.filterColor.value='';this.filterSeason.value='';this.filterStatus.value='';this.renderItems(); },

            // --- Outfits ---
            renderOutfits() { try{this.outfitsList.innerHTML='';if(!this.data.outfits||this.data.outfits.length===0){this.outfitsList.innerHTML='<p>No hay outfits.</p>';return;}const sorted=this.data.outfits.filter(o => o && typeof o === 'object').sort((a,b)=>(b.lastWorn||0)-(a.lastWorn||0)||(a.name||'').localeCompare(b.name||''));sorted.forEach(o=>{const d=document.createElement('div');d.classList.add('list-item');d.dataset.id=o.id;let items=Array.isArray(o.itemIds)?o.itemIds.map(id=>{const i=this.findItemById(id);return i?i.name:'<s>X</s>';}).join(', '):'Err';if(items.length>70)items=items.substring(0,70)+'...';d.innerHTML=`<div class="content"><strong>${o.name||'S/N'}</strong><p style="font-size:0.9em;color:#666;">${items}</p>${o.notes?`<p style="font-size:0.9em;">${o.notes}</p>`:''}<p class="usage-info">U:${o.timesWorn||0}. ${o.lastWorn?`Ú:${new Date(o.lastWorn).toLocaleDateString()}`:''}</p></div><div class="actions"><button class="btn btn-secondary btn-sm" onclick="App.markOutfitAsWorn(${o.id})">Usado</button><button class="btn btn-danger btn-sm" onclick="App.deleteOutfit(${o.id})">Del</button></div>`;this.outfitsList.appendChild(d);});}catch(e){console.error("Render outfits error:",e);this.outfitsList.innerHTML='<p style="color:red;">Error outfits.</p>';} },
            populateOutfitItemSelection() { try{this.outfitItemsSelection.innerHTML='';if(!this.data.items||this.data.items.length===0){this.outfitItemsSelection.innerHTML='<p>Añade prendas.</p>';return;}const sorted=this.data.items.filter(i => i).sort((a,b)=>(a.type||'').localeCompare(b.type||'')||(a.name||'').localeCompare(b.name||''));sorted.forEach(i=>{const l=document.createElement('label');l.innerHTML=`<input type="checkbox" value="${i.id}" name="outfitItem"> ${i.name} (${i.type})`;this.outfitItemsSelection.appendChild(l);});}catch(e){console.error("Populate outfit select error:",e);} },
            handleOutfitFormSubmit(event) { try{event.preventDefault();const name=this.outfitNameInput.value.trim();const notes=this.outfitNotesInput.value.trim();const sel=this.outfitItemsSelection.querySelectorAll('input:checked');const ids=Array.from(sel).map(i=>parseInt(i.value));if(!name){alert("Nombre?");return;}if(ids.length===0){alert("Prendas?");return;}const newO={id:this.getNextId('outfit'),name:name,itemIds:ids,notes:notes,timesWorn:0,lastWorn:null};this.data.outfits.push(newO);this.saveData();this.outfitForm.reset();this.populateOutfitItemSelection();alert("Outfit guardado.");this.navigateToSection('view-outfits');}catch(e){console.error("Save outfit error:",e);alert("Error saving outfit.");} },
             markOutfitAsWorn(id) { try{const o=this.data.outfits.find(x=>x?.id===id);if(o){o.timesWorn=(o.timesWorn||0)+1;o.lastWorn=Date.now();let itemsUpdated=false;if(Array.isArray(o.itemIds)){o.itemIds.forEach(itemId=>{const item=this.findItemById(itemId);if(this._updateItemWornStatus(item)){itemsUpdated=true;}});}this.saveData();this.renderOutfits();if(document.getElementById('stats')?.classList.contains('active')){this.renderStats();}if(document.getElementById('view-all')?.classList.contains('active')){this.renderItems();}}else{console.error("Outfit not found:",id);}}catch(e){console.error("Mark outfit worn error:",e);} },
            deleteOutfit(id) { try{const oName=this.data.outfits.find(o=>o?.id===id)?.name||'';if(confirm(`Borrar outfit ${oName}?`)){this.data.outfits=this.data.outfits.filter(o=>o?.id!==id);this.saveData();this.renderOutfits();console.log(`Outfit ID ${id} deleted.`);}}catch(e){console.error("Delete outfit error:",e);} },

             // --- Wishlist ---
             renderWishlist() { try{this.wishlistItemsContainer.innerHTML='';if(!this.data.wishlist||this.data.wishlist.length===0){this.wishlistItemsContainer.innerHTML='<p>Wishlist vacía.</p>';return;}this.data.wishlist.forEach(item=>{if(!item)return;const d=document.createElement('div');d.classList.add('list-item');d.dataset.id=item.id;let lH='';if(item.link){try{if(item.link.startsWith('http')){lH=`<br><a href="${item.link}" target="_blank" rel="noopener noreferrer" style="font-size:0.9em;">Ver enlace</a>`;}else{lH=`<br><span style="font-size:0.9em;color:gray;">(Link inválido)</span>`;}}catch(e){lH=`<br><span style="font-size:0.9em;color:gray;">(Link inválido)</span>`;}}d.innerHTML=`<div class="content"><strong>${item.name||'S/N'}</strong> ${lH}</div><div class="actions"><button class="btn btn-danger btn-sm" onclick="App.deleteWishlistItem(${item.id})">Del</button></div>`;this.wishlistItemsContainer.appendChild(d);});}catch(e){console.error("Render wishlist error:",e);} },
             handleAddWishlistItem(event) { try{event.preventDefault();const n=this.wishlistItemNameInput.value.trim();let l=this.wishlistItemLinkInput.value.trim();if(!n){alert("Nombre?");return;}let vL=l;if(l&&!l.startsWith('http')){vL='http://'+l;}const nI={id:this.getNextId('wishlist'),name:n,link:vL||null,addedDate:Date.now()};this.data.wishlist.push(nI);this.saveData();this.addWishlistItemForm.reset();this.renderWishlist();}catch(e){console.error("Add wishlist error:",e);} },
             deleteWishlistItem(id) { try{if(confirm("Quitar de wishlist?")){this.data.wishlist=this.data.wishlist.filter(i=>i?.id!==id);this.saveData();this.renderWishlist();}}catch(e){console.error("Delete wishlist error:",e);} },

             // --- Stats ---
             renderStats() { console.log("Rendering stats...");try{this.statsContent.querySelector('p').textContent="Calculando...";const tI=this.data.items.length;const tO=this.data.outfits.length;const now=new Date();const sevenDaysAgo=new Date(now.getTime()-(7*24*60*60*1000));sevenDaysAgo.setHours(0,0,0,0);const sevenDaysAgoTs=sevenDaysAgo.getTime();let weeklyItems=0;this.data.items.forEach(i=>{if(i?.lastWorn&&i.lastWorn>=sevenDaysAgoTs){weeklyItems++;}});let weeklyOutfits=0;this.data.outfits.forEach(o=>{if(o?.lastWorn&&o.lastWorn>=sevenDaysAgoTs){weeklyOutfits++;}});const itemsByType=this.data.items.reduce((a,i)=>{if(i?.type)a[i.type]=(a[i.type]||0)+1;return a;},{});const itemsByStatus=this.data.items.reduce((a,i)=>{if(i?.status)a[i.status]=(a[i.status]||0)+1;return a;},{});const topItems=[...this.data.items].filter(i=>i&&i.timesWorn>0).sort((a,b)=>(b.timesWorn||0)-(a.timesWorn||0)).slice(0,5);this.statsTotalItems.textContent=tI;this.statsTotalOutfits.textContent=tO;this.statsWeeklyItems.textContent=weeklyItems;this.statsWeeklyOutfits.textContent=weeklyOutfits;this.renderPieChart('typeChart','Prendas x Tipo',itemsByType);this.renderPieChart('statusChart','Prendas x Estado',itemsByStatus);this.renderBarChart('topItemsChart','Top 5 Prendas Usadas',topItems.map(i=>i.name),topItems.map(i=>i.timesWorn||0));this.statsContent.querySelector('p').textContent="";console.log("Stats rendered.");}catch(e){console.error("Stats error:",e);this.statsContent.innerHTML='<p style="color:red;">Error generando stats.</p>';}},
             renderPieChart(id,lbl,data) { const ctx=document.getElementById(id)?.getContext('2d');if(!ctx){console.error(`Canvas ${id} not found`);return;}if(this[`${id}Instance`]){this[`${id}Instance`].destroy();}const labels=Object.keys(data);const values=Object.values(data);this[`${id}Instance`]=new Chart(ctx,{type:'doughnut',data:{labels:labels,datasets:[{label:lbl,data:values,backgroundColor:['#5dadec','#4CAF50','#FFC107','#F44336','#9E9E9E','#2196F3','#FF9800','#E91E63','#795548','#607D8B'],hoverOffset:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},title:{display:true,text:lbl}}}}); },
             renderBarChart(id,lbl,labels,data) { const ctx=document.getElementById(id)?.getContext('2d');if(!ctx){console.error(`Canvas ${id} not found`);return;}if(this[`${id}Instance`]){this[`${id}Instance`].destroy();}this[`${id}Instance`]=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Veces',data:data,backgroundColor:'#5dadec'}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},title:{display:true,text:lbl}},scales:{x:{beginAtZero:true}}}}); },

            // --- Alertas ---
            renderAlerts() { try{this.alertsContent.innerHTML='';let hA=false;const now=Date.now();const stagThres=this.alertStatusStagnationDays*24*60*60*1000;const overused=this.data.items.filter(i=>i&&(i.timesWorn||0)>this.alertOveruseThreshold);if(overused.length>0){hA=true;let h=`<div class="alert alert-danger"><h4>Muy Usadas(+${this.alertOveruseThreshold})</h4><ul>`;overused.slice(0,5).forEach(i=>{h+=`<li>${i.name}(${i.timesWorn}v)</li>`;});if(overused.length>5)h+=`<li>...y ${overused.length-5} más</li>`;h+=`</ul></div>`;this.alertsContent.innerHTML+=h;}const stagnant=this.data.items.filter(i=>{if(!i||!Array.isArray(i.statusHistory)||i.statusHistory.length===0)return false;const last=i.statusHistory[i.statusHistory.length-1];return(last.status==='desgastado'||last.status==='para donar')&&(now-last.date>stagThres);});if(stagnant.length>0){hA=true;let h=`<div class="alert alert-warning"><h4>Estancadas(+${this.alertStatusStagnationDays}d)</h4><p style='font-size:.9em'>(Desgastado/Donar)</p><ul>`;stagnant.slice(0,10).forEach(i=>{h+=`<li>${i.name}(E:${i.status})</li>`;});if(stagnant.length>10)h+=`<li>...y ${stagnant.length-10} más</li>`;h+=`</ul></div>`;this.alertsContent.innerHTML+=h;}const oYA=now-(365*24*60*60*1000);const lUI=this.data.items.filter(i=>i&&((i.timesWorn>0&&i.lastWorn<oYA)||((i.timesWorn===0||!i.timesWorn)&&i.dateAdded<oYA)));if(lUI.length>0){hA=true;let h=`<div class="alert alert-secondary"><h4>Sin Usar Mucho(${lUI.length})</h4><ul>`;lUI.slice(0,10).forEach(i=>{h+=`<li>${i.name} ${i.lastWorn?`(últ.:${new Date(i.lastWorn).toLocaleDateString()})`:'(nunca)'}</li>`;});if(lUI.length>10)h+=`<li>...y ${lUI.length-10} más</li>`;h+=`</ul></div>`;this.alertsContent.innerHTML+=h;}if(!hA){this.alertsContent.innerHTML='<p>No hay alertas.</p>';}}catch(e){console.error("Alerts error:",e);this.alertsContent.innerHTML='<p style="color:red;">Error alertas.</p>';} },

            // --- Export/Import/Delete ---
            exportData() { try{if(this.data.items.length===0&&this.data.outfits.length===0&&this.data.wishlist.length===0){alert("Nada.");return;}const dS=JSON.stringify(this.data,null,2);const dB=new Blob([dS],{type:"application/json"});const url=URL.createObjectURL(dB);const l=document.createElement('a');l.href=url;const t=new Date().toISOString().slice(0,19).replace('T','_').replace(/:/g,'-');l.download=`armario_${t}.json`;document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(url);alert("Exportado.");}catch(e){console.error("Export error:",e);} },
            handleImportData() { const f=this.importInput.files[0];if(!f){alert("Selecciona.");return;}if(!confirm("Importar? Reemplazará todo!")){this.importInput.value='';return;}const r=new FileReader();r.onload=(e)=>{try{const iD=JSON.parse(e.target.result);if(iD&&typeof iD==='object'&&(Array.isArray(iD.items)||iD.items===undefined)&&(Array.isArray(iD.outfits)||iD.outfits===undefined)&&(Array.isArray(iD.wishlist)||iD.wishlist===undefined)&&(typeof iD.config==='object'||iD.config===undefined)){this.data={items:iD.items||[],outfits:iD.outfits||[],wishlist:iD.wishlist||[],config:iD.config||{nextItemId:1,nextOutfitId:1,nextWishlistItemId:1}};this.data.items.forEach(i=>{if(i&&typeof i==='object'){i.statusHistory=i.statusHistory||[];}}); this.data.outfits.forEach(o=>{if(o&&typeof o==='object'){o.timesWorn=o.timesWorn||0;o.lastWorn=o.lastWorn||null;}});this.data.config.nextItemId=this.data.config.nextItemId||(this.data.items.length?Math.max(0,...this.data.items.map(i=>i?.id||0)):0)+1;this.data.config.nextOutfitId=this.data.config.nextOutfitId||(this.data.outfits.length?Math.max(0,...this.data.outfits.map(o=>o?.id||0)):0)+1;this.data.config.nextWishlistItemId=this.data.config.nextWishlistItemId||(this.data.wishlist.length?Math.max(0,...this.data.wishlist.map(w=>w?.id||0)):0)+1;this.saveData();alert("Importado.");this.renderItems();this.populateFilterOptions();this.navigateToSection('view-all');}else{throw new Error("Bad JSON structure.");}}catch(err){console.error("Import error:",err);alert(`Error: ${err.message}`);}finally{this.importInput.value='';}};r.onerror=()=>{alert("Read error.");this.importInput.value='';};r.readAsText(f);},
            deleteAllData() { if(confirm("BORRAR TODO? IRREVERSIBLE.")){if(confirm("SEGURO???")){try{localStorage.removeItem('wardrobeApp');this.initializeEmptyData();alert("Borrado.");this.renderItems();this.renderOutfits();this.renderWishlist();this.renderStats();this.renderAlerts();this.populateFilterOptions();this.navigateToSection('view-all');}catch(e){console.error("Delete error:",e);}}} },

            // --- Listeners ---
            addEventListeners() { try{this.menuToggle.addEventListener('click',this.toggleMobileMenu.bind(this));this.overlay.addEventListener('click',this.closeMobileMenu.bind(this));this.sidebar.addEventListener('click',(e)=>{if(e.target.classList.contains('nav-btn')){this.navigateToSection(e.target.dataset.section);}});this.itemForm.addEventListener('submit',this.handleFormSubmit.bind(this));this.itemImageInput.addEventListener('change',this.handleImagePreview.bind(this));this.itemColorPicker.addEventListener('input',(e)=>{this.itemColorInput.value=e.target.value;});this.itemColorInput.addEventListener('change',(e)=>{const h=this.rgbToHex(e.target.value);if(h)this.itemColorPicker.value=h;});this.takePhotoButton.addEventListener('click',this.initCamera.bind(this));this.captureButton.addEventListener('click',this.capturePhoto.bind(this));this.cancelCameraButton.addEventListener('click',this.stopCameraStream.bind(this));this.filterSearch.addEventListener('input',this.applyFilters.bind(this));this.filterType.addEventListener('change',this.applyFilters.bind(this));this.filterColor.addEventListener('input',this.applyFilters.bind(this));this.filterSeason.addEventListener('change',this.applyFilters.bind(this));this.filterStatus.addEventListener('change',this.applyFilters.bind(this));this.resetFiltersBtn.addEventListener('click',this.resetFilters.bind(this));this.modalCloseBtn.addEventListener('click',this.closeModal.bind(this));this.cancelEditBtn.addEventListener('click',this.handleCancelEdit.bind(this));window.addEventListener('click',(e)=>{if(e.target==this.editModal){this.closeModal();}});this.outfitForm.addEventListener('submit',this.handleOutfitFormSubmit.bind(this));this.addWishlistItemForm.addEventListener('submit',this.handleAddWishlistItem.bind(this));this.exportBtn.addEventListener('click',this.exportData.bind(this));this.importBtn.addEventListener('click',this.handleImportData.bind(this));this.deleteAllBtn.addEventListener('click',this.deleteAllData.bind(this));}catch(e){console.error("Listener error:",e);} }
        }; // FIN App

        // --- Ejecutar ---
        document.addEventListener('DOMContentLoaded', () => { try { App.init(); window.App = App; } catch (error) { console.error("CRITICAL INIT ERROR:", error); document.body.innerHTML = `<div style="padding:20px;color:red;"><h2>Error Fatal</h2><p>No se pudo iniciar. Revisa la consola (F12).</p><pre>${error.stack||error}</pre></div>`; } });
        // --- Funciones Globales ---
        function closeModal() { if (window.App) { window.App.closeModal(); } }
    </script>
</body>
</html>